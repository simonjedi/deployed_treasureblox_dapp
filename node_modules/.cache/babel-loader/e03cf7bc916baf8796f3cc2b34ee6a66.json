{"ast":null,"code":"'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.extendContracts = void 0;\n\nconst debug = require('debug')('meter:injector');\n\nconst Subscription = require('web3-core-subscriptions').subscription;\n\nconst formatters_1 = require(\"./formatters\");\n\nconst extendContracts = function (web3) {\n  const _encodeEventABI = web3.eth.Contract.prototype._encodeEventABI;\n\n  web3.eth.Contract.prototype._encodeEventABI = function (event, options) {\n    debug('_encodeEventABI');\n\n    const result = _encodeEventABI.call(this, event, options);\n\n    if (options.options) {\n      result.options = options.options;\n    }\n\n    if (options.range) {\n      result.range = options.range;\n    }\n\n    if (options.order) {\n      result.order = options.order;\n    }\n\n    return result;\n  };\n\n  web3.eth.Contract.prototype._on = function () {\n    debug('_on'); // keeps the code from web3\n\n    const subOptions = this._generateEventOptions.apply(this, arguments); // prevent the event \"newListener\" and \"removeListener\" from being overwritten\n\n\n    this._checkListener('newListener', subOptions.event.name, subOptions.callback);\n\n    this._checkListener('removeListener', subOptions.event.name, subOptions.callback); // TODO check if listener already exists? and reuse subscription if options are the same.\n    // create new subscription\n\n    /* changes from web3 starts the following\n     */\n    // subscription options in meter doesn't support array as topic filter object\n\n\n    const filterOptions = {\n      address: subOptions.params.address\n    };\n    debug('Contract filter option: %O', filterOptions);\n\n    if (subOptions.params.topics) {\n      for (const [index, value] of subOptions.params.topics.entries()) {\n        if (value === null) {\n          continue;\n        }\n\n        if (typeof value === 'string') {\n          filterOptions['t' + index] = value;\n        } else {\n          throw new Error('[meterify] Array filter option is not supported in meter, must be null or bytes32 string');\n        }\n      }\n    }\n\n    const decodeEventABI = this._decodeEventABI.bind(subOptions.event);\n\n    const subscription = new Subscription({\n      subscription: {\n        params: 1,\n        inputFormatter: [formatters_1.inputLogFilterFormatter],\n\n        subscriptionHandler(subscriptionMsg) {\n          if (subscriptionMsg.error) {\n            this.emit('error', subscriptionMsg.error); // web3-core-subscriptions/subscription sets a default value for this.callback\n\n            this.callback(subscriptionMsg.error, null, this);\n          } else {\n            const result = decodeEventABI(subscriptionMsg.data);\n\n            if (result.removed) {\n              this.emit('changed', result);\n            } else {\n              this.emit('data', result);\n            } // web3-core-subscriptions/subscription sets a default value for this.callback\n\n\n            this.callback(null, result, this);\n          }\n        }\n\n      },\n      type: 'eth',\n      requestManager: this._requestManager\n    });\n    subscription.subscribe('logs', filterOptions, subOptions.callback || function () {});\n    return subscription;\n  };\n};\n\nexports.extendContracts = extendContracts;","map":{"version":3,"sources":["../../src/extend/contracts.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["'use strict';\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.extendContracts = void 0;\nconst debug = require('debug')('meter:injector');\nconst Subscription = require('web3-core-subscriptions').subscription;\nconst formatters_1 = require(\"./formatters\");\nconst extendContracts = function (web3) {\n    const _encodeEventABI = web3.eth.Contract.prototype._encodeEventABI;\n    web3.eth.Contract.prototype._encodeEventABI = function (event, options) {\n        debug('_encodeEventABI');\n        const result = _encodeEventABI.call(this, event, options);\n        if (options.options) {\n            result.options = options.options;\n        }\n        if (options.range) {\n            result.range = options.range;\n        }\n        if (options.order) {\n            result.order = options.order;\n        }\n        return result;\n    };\n    web3.eth.Contract.prototype._on = function () {\n        debug('_on');\n        // keeps the code from web3\n        const subOptions = this._generateEventOptions.apply(this, arguments);\n        // prevent the event \"newListener\" and \"removeListener\" from being overwritten\n        this._checkListener('newListener', subOptions.event.name, subOptions.callback);\n        this._checkListener('removeListener', subOptions.event.name, subOptions.callback);\n        // TODO check if listener already exists? and reuse subscription if options are the same.\n        // create new subscription\n        /* changes from web3 starts the following\n         */\n        // subscription options in meter doesn't support array as topic filter object\n        const filterOptions = {\n            address: subOptions.params.address,\n        };\n        debug('Contract filter option: %O', filterOptions);\n        if (subOptions.params.topics) {\n            for (const [index, value] of subOptions.params.topics.entries()) {\n                if (value === null) {\n                    continue;\n                }\n                if (typeof value === 'string') {\n                    filterOptions['t' + index] = value;\n                }\n                else {\n                    throw new Error('[meterify] Array filter option is not supported in meter, must be null or bytes32 string');\n                }\n            }\n        }\n        const decodeEventABI = this._decodeEventABI.bind(subOptions.event);\n        const subscription = new Subscription({\n            subscription: {\n                params: 1,\n                inputFormatter: [formatters_1.inputLogFilterFormatter],\n                subscriptionHandler(subscriptionMsg) {\n                    if (subscriptionMsg.error) {\n                        this.emit('error', subscriptionMsg.error);\n                        // web3-core-subscriptions/subscription sets a default value for this.callback\n                        this.callback(subscriptionMsg.error, null, this);\n                    }\n                    else {\n                        const result = decodeEventABI(subscriptionMsg.data);\n                        if (result.removed) {\n                            this.emit('changed', result);\n                        }\n                        else {\n                            this.emit('data', result);\n                        }\n                        // web3-core-subscriptions/subscription sets a default value for this.callback\n                        this.callback(null, result, this);\n                    }\n                },\n            },\n            type: 'eth',\n            requestManager: this._requestManager,\n        });\n        subscription.subscribe('logs', filterOptions, subOptions.callback || function () { });\n        return subscription;\n    };\n};\nexports.extendContracts = extendContracts;\n//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJhY3RzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2V4dGVuZC9jb250cmFjdHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFBOzs7QUFDWixNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsZ0JBQWdCLENBQUMsQ0FBQTtBQUNoRCxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMseUJBQXlCLENBQUMsQ0FBQyxZQUFZLENBQUE7QUFFcEUsNkNBQXNEO0FBRXRELE1BQU0sZUFBZSxHQUFHLFVBQVMsSUFBUztJQUN0QyxNQUFNLGVBQWUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsZUFBZSxDQUFBO0lBQ25FLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxlQUFlLEdBQUcsVUFBUyxLQUFVLEVBQUUsT0FBWTtRQUMzRSxLQUFLLENBQUMsaUJBQWlCLENBQUMsQ0FBQTtRQUN4QixNQUFNLE1BQU0sR0FBRyxlQUFlLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUE7UUFDekQsSUFBSSxPQUFPLENBQUMsT0FBTyxFQUFFO1lBQ2pCLE1BQU0sQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQTtTQUNuQztRQUNELElBQUksT0FBTyxDQUFDLEtBQUssRUFBRTtZQUNmLE1BQU0sQ0FBQyxLQUFLLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQTtTQUMvQjtRQUNELElBQUksT0FBTyxDQUFDLEtBQUssRUFBRTtZQUNmLE1BQU0sQ0FBQyxLQUFLLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQTtTQUMvQjtRQUNELE9BQU8sTUFBTSxDQUFBO0lBQ2pCLENBQUMsQ0FBQTtJQUVELElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxHQUFHLEdBQUc7UUFDOUIsS0FB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"]},"metadata":{},"sourceType":"script"}