"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const address_1 = require("./cry/address");
const blake2b_1 = require("./cry/blake2b");
const secp256k1_1 = require("./cry/secp256k1");
const fastJsonStableStringify = require('fast-json-stable-stringify');
var Certificate;
(function (Certificate) {
    function safeToLowerCase(str) {
        return typeof str === 'string' ? str.toLowerCase() : str;
    }
    /**
     * deterministically encode cert into JSON
     * @param cert cert object
     */
    function encode(cert) {
        return fastJsonStableStringify(Object.assign(Object.assign({}, cert), { signer: safeToLowerCase(cert.signer), signature: cert.signature ? safeToLowerCase(cert.signature) : cert.signature }));
    }
    Certificate.encode = encode;
    /**
     * verify the cert
     * @param cert cert object with signature
     */
    function verify(cert) {
        if (!cert.signature) {
            throw new Error('signature missing');
        }
        const { signature } = cert;
        if (!/^0x[0-9a-f]+$/i.test(signature) || signature.length % 2 !== 0) {
            throw new Error('invalid signature');
        }
        const encoded = encode(Object.assign(Object.assign({}, cert), { signature: undefined }));
        const signingHash = blake2b_1.blake2b256(encoded);
        const pubKey = secp256k1_1.secp256k1.recover(signingHash, Buffer.from(signature.slice(2), 'hex'));
        if (`0x${address_1.publicKeyToAddress(pubKey).toString('hex')}` !== safeToLowerCase(cert.signer)) {
            throw new Error('signature does not match with signer');
        }
    }
    Certificate.verify = verify;
})(Certificate = exports.Certificate || (exports.Certificate = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2VydGlmaWNhdGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvY2VydGlmaWNhdGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwyQ0FBbUQ7QUFDbkQsMkNBQTJDO0FBQzNDLCtDQUE0QztBQUU1QyxNQUFNLHVCQUF1QixHQUFHLE9BQU8sQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO0FBbUJ0RSxJQUFpQixXQUFXLENBc0MzQjtBQXRDRCxXQUFpQixXQUFXO0lBQzFCLFNBQVMsZUFBZSxDQUFDLEdBQVc7UUFDbEMsT0FBTyxPQUFPLEdBQUcsS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO0lBQzNELENBQUM7SUFDRDs7O09BR0c7SUFDSCxTQUFnQixNQUFNLENBQUMsSUFBaUI7UUFDdEMsT0FBTyx1QkFBdUIsaUNBQ3pCLElBQUksS0FDUCxNQUFNLEVBQUUsZUFBZSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFDcEMsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLElBQ2xFLENBQUM7SUFDZixDQUFDO0lBTmUsa0JBQU0sU0FNckIsQ0FBQTtJQUVEOzs7T0FHRztJQUNILFNBQWdCLE1BQU0sQ0FBQyxJQUFpQjtRQUN0QyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNuQixNQUFNLElBQUksS0FBSyxDQUFDLG1CQUFtQixDQUFDLENBQUM7U0FDdEM7UUFDRCxNQUFNLEVBQUUsU0FBUyxFQUFFLEdBQUcsSUFBSSxDQUFDO1FBQzNCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksU0FBUyxDQUFDLE1BQU0sR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ25FLE1BQU0sSUFBSSxLQUFLLENBQUMsbUJBQW1CLENBQUMsQ0FBQztTQUN0QztRQUVELE1BQU0sT0FBTyxHQUFHLE1BQU0saUNBQU0sSUFBSSxLQUFFLFNBQVMsRUFBRSxTQUFTLElBQUcsQ0FBQztRQUMxRCxNQUFNLFdBQVcsR0FBRyxvQkFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXhDLE1BQU0sTUFBTSxHQUFHLHFCQUFTLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUV0RixJQUFJLEtBQUssNEJBQWtCLENBQUMsTUFBTSxDQUFDLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUFFLEtBQUssZUFBZSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUN0RixNQUFNLElBQUksS0FBSyxDQUFDLHNDQUFzQyxDQUFDLENBQUM7U0FDekQ7SUFDSCxDQUFDO0lBakJlLGtCQUFNLFNBaUJyQixDQUFBO0FBQ0gsQ0FBQyxFQXRDZ0IsV0FBVyxHQUFYLG1CQUFXLEtBQVgsbUJBQVcsUUFzQzNCIn0=