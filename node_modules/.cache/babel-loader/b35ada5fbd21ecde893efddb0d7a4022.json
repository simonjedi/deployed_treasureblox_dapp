{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n    label: 0,\n    sent: function () {\n      if (t[0] & 1) throw t[1];\n      return t[1];\n    },\n    trys: [],\n    ops: []\n  },\n      f,\n      y,\n      t,\n      g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n\n        case 7:\n          op = _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n\n            _.ops.push(op);\n\n            break;\n          }\n\n          if (t[2]) _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n      }\n\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.decodeSig = exports.verifySignatureWithoutPrefix = exports.verifyEIP712TypedDataSigner = exports.recoverMessageSigner = exports.recoverTransaction = exports.extractSignature = exports.encodeTransaction = exports.rlpEncodedTx = exports.getHashFromEncoded = exports.chainIdTransformationForSigning = exports.thirtyTwo = exports.sixtyFour = exports.publicKeyPrefix = void 0;\n\nvar address_1 = require(\"@celo/base/lib/address\");\n\nvar formatter_1 = require(\"@celo/connect/lib/utils/formatter\");\n\nvar sign_typed_data_utils_1 = require(\"@celo/utils/lib/sign-typed-data-utils\");\n\nvar signatureUtils_1 = require(\"@celo/utils/lib/signatureUtils\");\n\nvar debug_1 = __importDefault(require(\"debug\")); // @ts-ignore-next-line\n\n\nvar eth_lib_1 = require(\"eth-lib\");\n\nvar ethUtil = __importStar(require(\"ethereumjs-util\"));\n\nvar debug = (0, debug_1.default)('wallet-base:tx:sign'); // Original code taken from\n// https://github.com/ethereum/web3.js/blob/1.x/packages/web3-eth-accounts/src/index.js\n// 0x04 prefix indicates that the key is not compressed\n// https://tools.ietf.org/html/rfc5480#section-2.2\n\nexports.publicKeyPrefix = 0x04;\nexports.sixtyFour = 64;\nexports.thirtyTwo = 32;\n\nfunction isNullOrUndefined(value) {\n  return value === null || value === undefined;\n} // Simple replay attack protection\n// https://github.com/ethereum/EIPs/blob/master/EIPS/eip-155.md\n\n\nfunction chainIdTransformationForSigning(chainId) {\n  return chainId * 2 + 35;\n}\n\nexports.chainIdTransformationForSigning = chainIdTransformationForSigning;\n\nfunction getHashFromEncoded(rlpEncode) {\n  return eth_lib_1.hash.keccak256(rlpEncode);\n}\n\nexports.getHashFromEncoded = getHashFromEncoded;\n\nfunction trimLeadingZero(hex) {\n  while (hex && hex.startsWith('0x0')) {\n    hex = (0, address_1.ensureLeading0x)(hex.slice(3));\n  }\n\n  return hex;\n}\n\nfunction makeEven(hex) {\n  if (hex.length % 2 === 1) {\n    hex = hex.replace('0x', '0x0');\n  }\n\n  return hex;\n}\n\nfunction signatureFormatter(signature) {\n  return {\n    v: stringNumberToHex(signature.v),\n    r: makeEven(trimLeadingZero((0, address_1.ensureLeading0x)(signature.r.toString('hex')))),\n    s: makeEven(trimLeadingZero((0, address_1.ensureLeading0x)(signature.s.toString('hex'))))\n  };\n}\n\nfunction stringNumberToHex(num) {\n  var auxNumber = Number(num);\n\n  if (num === '0x' || num === undefined || auxNumber === 0) {\n    return '0x';\n  }\n\n  return eth_lib_1.bytes.fromNumber(auxNumber);\n}\n\nfunction rlpEncodedTx(tx) {\n  var _a, _b;\n\n  if (!tx.gas) {\n    throw new Error('\"gas\" is missing');\n  }\n\n  if (isNullOrUndefined(tx.chainId) || isNullOrUndefined(tx.gasPrice) || isNullOrUndefined(tx.nonce)) {\n    throw new Error('One of the values \"chainId\", \"gasPrice\", or \"nonce\" couldn\\'t be fetched: ' + JSON.stringify({\n      chainId: tx.chainId,\n      gasPrice: tx.gasPrice,\n      nonce: tx.nonce\n    }));\n  }\n\n  if (tx.nonce < 0 || tx.gas < 0 || tx.gasPrice < 0 || tx.chainId < 0) {\n    throw new Error('Gas, gasPrice, nonce or chainId is lower than 0');\n  }\n\n  var transaction = (0, formatter_1.inputCeloTxFormatter)(tx);\n  transaction.to = eth_lib_1.bytes.fromNat(tx.to || '0x').toLowerCase();\n  transaction.nonce = Number((tx.nonce !== '0x' ? tx.nonce : 0) || 0);\n  transaction.data = eth_lib_1.bytes.fromNat(tx.data || '0x').toLowerCase();\n  transaction.value = stringNumberToHex((_a = tx.value) === null || _a === void 0 ? void 0 : _a.toString());\n  transaction.feeCurrency = eth_lib_1.bytes.fromNat(tx.feeCurrency || '0x').toLowerCase();\n  transaction.gatewayFeeRecipient = eth_lib_1.bytes.fromNat(tx.gatewayFeeRecipient || '0x').toLowerCase();\n  transaction.gatewayFee = stringNumberToHex(tx.gatewayFee);\n  transaction.gasPrice = stringNumberToHex((_b = tx.gasPrice) === null || _b === void 0 ? void 0 : _b.toString());\n  transaction.gas = stringNumberToHex(tx.gas);\n  transaction.chainId = tx.chainId || 1; // This order should match the order in Geth.\n  // https://github.com/celo-org/celo-blockchain/blob/027dba2e4584936cc5a8e8993e4e27d28d5247b8/core/types/transaction.go#L65\n\n  var rlpEncode = eth_lib_1.RLP.encode([stringNumberToHex(transaction.nonce), transaction.gasPrice, transaction.gas, transaction.feeCurrency, transaction.gatewayFeeRecipient, transaction.gatewayFee, transaction.to, transaction.value, transaction.data, stringNumberToHex(transaction.chainId), '0x', '0x']);\n  return {\n    transaction: transaction,\n    rlpEncode: rlpEncode\n  };\n}\n\nexports.rlpEncodedTx = rlpEncodedTx;\n\nfunction encodeTransaction(rlpEncoded, signature) {\n  return __awaiter(this, void 0, void 0, function () {\n    var sanitizedSignature, v, r, s, rawTx, rawTransaction, hash, result;\n    return __generator(this, function (_a) {\n      sanitizedSignature = signatureFormatter(signature);\n      v = sanitizedSignature.v;\n      r = sanitizedSignature.r;\n      s = sanitizedSignature.s;\n      rawTx = eth_lib_1.RLP.decode(rlpEncoded.rlpEncode).slice(0, 9).concat([v, r, s]);\n      rawTransaction = eth_lib_1.RLP.encode(rawTx);\n      hash = getHashFromEncoded(rawTransaction);\n      result = {\n        tx: {\n          nonce: rlpEncoded.transaction.nonce.toString(),\n          gasPrice: rlpEncoded.transaction.gasPrice.toString(),\n          gas: rlpEncoded.transaction.gas.toString(),\n          to: rlpEncoded.transaction.to.toString(),\n          value: rlpEncoded.transaction.value.toString(),\n          input: rlpEncoded.transaction.data,\n          feeCurrency: rlpEncoded.transaction.feeCurrency.toString(),\n          gatewayFeeRecipient: rlpEncoded.transaction.gatewayFeeRecipient.toString(),\n          gatewayFee: rlpEncoded.transaction.gatewayFee.toString(),\n          v: v,\n          r: r,\n          s: s,\n          hash: hash\n        },\n        raw: rawTransaction\n      };\n      return [2\n      /*return*/\n      , result];\n    });\n  });\n}\n\nexports.encodeTransaction = encodeTransaction;\n\nfunction extractSignature(rawTx) {\n  var rawValues = eth_lib_1.RLP.decode(rawTx);\n  var r = rawValues[10];\n  var s = rawValues[11]; // Account.recover cannot handle canonicalized signatures\n  // A canonicalized signature may have the first byte removed if its value is 0\n\n  r = (0, address_1.ensureLeading0x)((0, address_1.trimLeading0x)(r).padStart(64, '0'));\n  s = (0, address_1.ensureLeading0x)((0, address_1.trimLeading0x)(s).padStart(64, '0'));\n  return {\n    v: rawValues[9],\n    r: r,\n    s: s\n  };\n}\n\nexports.extractSignature = extractSignature; // Recover transaction and sender address from a raw transaction.\n// This is used for testing.\n\nfunction recoverTransaction(rawTx) {\n  var rawValues = eth_lib_1.RLP.decode(rawTx);\n  debug('signing-utils@recoverTransaction: values are %s', rawValues);\n  var recovery = eth_lib_1.bytes.toNumber(rawValues[9]); // tslint:disable-next-line:no-bitwise\n\n  var chainId = eth_lib_1.bytes.fromNumber(recovery - 35 >> 1);\n  var celoTx = {\n    nonce: rawValues[0].toLowerCase() === '0x' ? 0 : parseInt(rawValues[0], 16),\n    gasPrice: rawValues[1].toLowerCase() === '0x' ? 0 : parseInt(rawValues[1], 16),\n    gas: rawValues[2].toLowerCase() === '0x' ? 0 : parseInt(rawValues[2], 16),\n    feeCurrency: rawValues[3],\n    gatewayFeeRecipient: rawValues[4],\n    gatewayFee: rawValues[5],\n    to: rawValues[6],\n    value: rawValues[7],\n    data: rawValues[8],\n    chainId: chainId\n  };\n  var r = rawValues[10];\n  var s = rawValues[11]; // Account.recover cannot handle canonicalized signatures\n  // A canonicalized signature may have the first byte removed if its value is 0\n\n  r = (0, address_1.ensureLeading0x)((0, address_1.trimLeading0x)(r).padStart(64, '0'));\n  s = (0, address_1.ensureLeading0x)((0, address_1.trimLeading0x)(s).padStart(64, '0'));\n  var signature = eth_lib_1.account.encodeSignature([rawValues[9], r, s]);\n  var extraData = recovery < 35 ? [] : [chainId, '0x', '0x'];\n  var signingData = rawValues.slice(0, 9).concat(extraData);\n  var signingDataHex = eth_lib_1.RLP.encode(signingData);\n  var signer = eth_lib_1.account.recover(getHashFromEncoded(signingDataHex), signature);\n  return [celoTx, signer];\n}\n\nexports.recoverTransaction = recoverTransaction;\n\nfunction recoverMessageSigner(signingDataHex, signedData) {\n  var dataBuff = ethUtil.toBuffer(signingDataHex);\n  var msgHashBuff = ethUtil.hashPersonalMessage(dataBuff);\n  var signature = ethUtil.fromRpcSig(signedData);\n  var publicKey = ethUtil.ecrecover(msgHashBuff, signature.v, signature.r, signature.s);\n  var address = ethUtil.pubToAddress(publicKey, true);\n  return (0, address_1.ensureLeading0x)(address.toString('hex'));\n}\n\nexports.recoverMessageSigner = recoverMessageSigner;\n\nfunction verifyEIP712TypedDataSigner(typedData, signedData, expectedAddress) {\n  var dataBuff = (0, sign_typed_data_utils_1.generateTypedDataHash)(typedData);\n  var trimmedData = dataBuff.toString('hex');\n  return verifySignatureWithoutPrefix((0, address_1.ensureLeading0x)(trimmedData), signedData, expectedAddress);\n}\n\nexports.verifyEIP712TypedDataSigner = verifyEIP712TypedDataSigner;\n\nfunction verifySignatureWithoutPrefix(messageHash, signature, signer) {\n  try {\n    (0, signatureUtils_1.parseSignatureWithoutPrefix)(messageHash, signature, signer);\n    return true;\n  } catch (error) {\n    return false;\n  }\n}\n\nexports.verifySignatureWithoutPrefix = verifySignatureWithoutPrefix;\n\nfunction decodeSig(sig) {\n  var _a = eth_lib_1.account.decodeSignature(sig),\n      v = _a[0],\n      r = _a[1],\n      s = _a[2];\n\n  return {\n    v: parseInt(v, 16),\n    r: ethUtil.toBuffer(r),\n    s: ethUtil.toBuffer(s)\n  };\n}\n\nexports.decodeSig = decodeSig;","map":{"version":3,"sources":["../src/signing-utils.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n    __setModuleDefault(result, mod);\n    return result;\n};\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.decodeSig = exports.verifySignatureWithoutPrefix = exports.verifyEIP712TypedDataSigner = exports.recoverMessageSigner = exports.recoverTransaction = exports.extractSignature = exports.encodeTransaction = exports.rlpEncodedTx = exports.getHashFromEncoded = exports.chainIdTransformationForSigning = exports.thirtyTwo = exports.sixtyFour = exports.publicKeyPrefix = void 0;\nvar address_1 = require(\"@celo/base/lib/address\");\nvar formatter_1 = require(\"@celo/connect/lib/utils/formatter\");\nvar sign_typed_data_utils_1 = require(\"@celo/utils/lib/sign-typed-data-utils\");\nvar signatureUtils_1 = require(\"@celo/utils/lib/signatureUtils\");\nvar debug_1 = __importDefault(require(\"debug\"));\n// @ts-ignore-next-line\nvar eth_lib_1 = require(\"eth-lib\");\nvar ethUtil = __importStar(require(\"ethereumjs-util\"));\nvar debug = (0, debug_1.default)('wallet-base:tx:sign');\n// Original code taken from\n// https://github.com/ethereum/web3.js/blob/1.x/packages/web3-eth-accounts/src/index.js\n// 0x04 prefix indicates that the key is not compressed\n// https://tools.ietf.org/html/rfc5480#section-2.2\nexports.publicKeyPrefix = 0x04;\nexports.sixtyFour = 64;\nexports.thirtyTwo = 32;\nfunction isNullOrUndefined(value) {\n    return value === null || value === undefined;\n}\n// Simple replay attack protection\n// https://github.com/ethereum/EIPs/blob/master/EIPS/eip-155.md\nfunction chainIdTransformationForSigning(chainId) {\n    return chainId * 2 + 35;\n}\nexports.chainIdTransformationForSigning = chainIdTransformationForSigning;\nfunction getHashFromEncoded(rlpEncode) {\n    return eth_lib_1.hash.keccak256(rlpEncode);\n}\nexports.getHashFromEncoded = getHashFromEncoded;\nfunction trimLeadingZero(hex) {\n    while (hex && hex.startsWith('0x0')) {\n        hex = (0, address_1.ensureLeading0x)(hex.slice(3));\n    }\n    return hex;\n}\nfunction makeEven(hex) {\n    if (hex.length % 2 === 1) {\n        hex = hex.replace('0x', '0x0');\n    }\n    return hex;\n}\nfunction signatureFormatter(signature) {\n    return {\n        v: stringNumberToHex(signature.v),\n        r: makeEven(trimLeadingZero((0, address_1.ensureLeading0x)(signature.r.toString('hex')))),\n        s: makeEven(trimLeadingZero((0, address_1.ensureLeading0x)(signature.s.toString('hex')))),\n    };\n}\nfunction stringNumberToHex(num) {\n    var auxNumber = Number(num);\n    if (num === '0x' || num === undefined || auxNumber === 0) {\n        return '0x';\n    }\n    return eth_lib_1.bytes.fromNumber(auxNumber);\n}\nfunction rlpEncodedTx(tx) {\n    var _a, _b;\n    if (!tx.gas) {\n        throw new Error('\"gas\" is missing');\n    }\n    if (isNullOrUndefined(tx.chainId) ||\n        isNullOrUndefined(tx.gasPrice) ||\n        isNullOrUndefined(tx.nonce)) {\n        throw new Error('One of the values \"chainId\", \"gasPrice\", or \"nonce\" couldn\\'t be fetched: ' +\n            JSON.stringify({ chainId: tx.chainId, gasPrice: tx.gasPrice, nonce: tx.nonce }));\n    }\n    if (tx.nonce < 0 || tx.gas < 0 || tx.gasPrice < 0 || tx.chainId < 0) {\n        throw new Error('Gas, gasPrice, nonce or chainId is lower than 0');\n    }\n    var transaction = (0, formatter_1.inputCeloTxFormatter)(tx);\n    transaction.to = eth_lib_1.bytes.fromNat(tx.to || '0x').toLowerCase();\n    transaction.nonce = Number((tx.nonce !== '0x' ? tx.nonce : 0) || 0);\n    transaction.data = eth_lib_1.bytes.fromNat(tx.data || '0x').toLowerCase();\n    transaction.value = stringNumberToHex((_a = tx.value) === null || _a === void 0 ? void 0 : _a.toString());\n    transaction.feeCurrency = eth_lib_1.bytes.fromNat(tx.feeCurrency || '0x').toLowerCase();\n    transaction.gatewayFeeRecipient = eth_lib_1.bytes.fromNat(tx.gatewayFeeRecipient || '0x').toLowerCase();\n    transaction.gatewayFee = stringNumberToHex(tx.gatewayFee);\n    transaction.gasPrice = stringNumberToHex((_b = tx.gasPrice) === null || _b === void 0 ? void 0 : _b.toString());\n    transaction.gas = stringNumberToHex(tx.gas);\n    transaction.chainId = tx.chainId || 1;\n    // This order should match the order in Geth.\n    // https://github.com/celo-org/celo-blockchain/blob/027dba2e4584936cc5a8e8993e4e27d28d5247b8/core/types/transaction.go#L65\n    var rlpEncode = eth_lib_1.RLP.encode([\n        stringNumberToHex(transaction.nonce),\n        transaction.gasPrice,\n        transaction.gas,\n        transaction.feeCurrency,\n        transaction.gatewayFeeRecipient,\n        transaction.gatewayFee,\n        transaction.to,\n        transaction.value,\n        transaction.data,\n        stringNumberToHex(transaction.chainId),\n        '0x',\n        '0x',\n    ]);\n    return { transaction: transaction, rlpEncode: rlpEncode };\n}\nexports.rlpEncodedTx = rlpEncodedTx;\nfunction encodeTransaction(rlpEncoded, signature) {\n    return __awaiter(this, void 0, void 0, function () {\n        var sanitizedSignature, v, r, s, rawTx, rawTransaction, hash, result;\n        return __generator(this, function (_a) {\n            sanitizedSignature = signatureFormatter(signature);\n            v = sanitizedSignature.v;\n            r = sanitizedSignature.r;\n            s = sanitizedSignature.s;\n            rawTx = eth_lib_1.RLP.decode(rlpEncoded.rlpEncode).slice(0, 9).concat([v, r, s]);\n            rawTransaction = eth_lib_1.RLP.encode(rawTx);\n            hash = getHashFromEncoded(rawTransaction);\n            result = {\n                tx: {\n                    nonce: rlpEncoded.transaction.nonce.toString(),\n                    gasPrice: rlpEncoded.transaction.gasPrice.toString(),\n                    gas: rlpEncoded.transaction.gas.toString(),\n                    to: rlpEncoded.transaction.to.toString(),\n                    value: rlpEncoded.transaction.value.toString(),\n                    input: rlpEncoded.transaction.data,\n                    feeCurrency: rlpEncoded.transaction.feeCurrency.toString(),\n                    gatewayFeeRecipient: rlpEncoded.transaction.gatewayFeeRecipient.toString(),\n                    gatewayFee: rlpEncoded.transaction.gatewayFee.toString(),\n                    v: v,\n                    r: r,\n                    s: s,\n                    hash: hash,\n                },\n                raw: rawTransaction,\n            };\n            return [2 /*return*/, result];\n        });\n    });\n}\nexports.encodeTransaction = encodeTransaction;\nfunction extractSignature(rawTx) {\n    var rawValues = eth_lib_1.RLP.decode(rawTx);\n    var r = rawValues[10];\n    var s = rawValues[11];\n    // Account.recover cannot handle canonicalized signatures\n    // A canonicalized signature may have the first byte removed if its value is 0\n    r = (0, address_1.ensureLeading0x)((0, address_1.trimLeading0x)(r).padStart(64, '0'));\n    s = (0, address_1.ensureLeading0x)((0, address_1.trimLeading0x)(s).padStart(64, '0'));\n    return {\n        v: rawValues[9],\n        r: r,\n        s: s,\n    };\n}\nexports.extractSignature = extractSignature;\n// Recover transaction and sender address from a raw transaction.\n// This is used for testing.\nfunction recoverTransaction(rawTx) {\n    var rawValues = eth_lib_1.RLP.decode(rawTx);\n    debug('signing-utils@recoverTransaction: values are %s', rawValues);\n    var recovery = eth_lib_1.bytes.toNumber(rawValues[9]);\n    // tslint:disable-next-line:no-bitwise\n    var chainId = eth_lib_1.bytes.fromNumber((recovery - 35) >> 1);\n    var celoTx = {\n        nonce: rawValues[0].toLowerCase() === '0x' ? 0 : parseInt(rawValues[0], 16),\n        gasPrice: rawValues[1].toLowerCase() === '0x' ? 0 : parseInt(rawValues[1], 16),\n        gas: rawValues[2].toLowerCase() === '0x' ? 0 : parseInt(rawValues[2], 16),\n        feeCurrency: rawValues[3],\n        gatewayFeeRecipient: rawValues[4],\n        gatewayFee: rawValues[5],\n        to: rawValues[6],\n        value: rawValues[7],\n        data: rawValues[8],\n        chainId: chainId,\n    };\n    var r = rawValues[10];\n    var s = rawValues[11];\n    // Account.recover cannot handle canonicalized signatures\n    // A canonicalized signature may have the first byte removed if its value is 0\n    r = (0, address_1.ensureLeading0x)((0, address_1.trimLeading0x)(r).padStart(64, '0'));\n    s = (0, address_1.ensureLeading0x)((0, address_1.trimLeading0x)(s).padStart(64, '0'));\n    var signature = eth_lib_1.account.encodeSignature([rawValues[9], r, s]);\n    var extraData = recovery < 35 ? [] : [chainId, '0x', '0x'];\n    var signingData = rawValues.slice(0, 9).concat(extraData);\n    var signingDataHex = eth_lib_1.RLP.encode(signingData);\n    var signer = eth_lib_1.account.recover(getHashFromEncoded(signingDataHex), signature);\n    return [celoTx, signer];\n}\nexports.recoverTransaction = recoverTransaction;\nfunction recoverMessageSigner(signingDataHex, signedData) {\n    var dataBuff = ethUtil.toBuffer(signingDataHex);\n    var msgHashBuff = ethUtil.hashPersonalMessage(dataBuff);\n    var signature = ethUtil.fromRpcSig(signedData);\n    var publicKey = ethUtil.ecrecover(msgHashBuff, signature.v, signature.r, signature.s);\n    var address = ethUtil.pubToAddress(publicKey, true);\n    return (0, address_1.ensureLeading0x)(address.toString('hex'));\n}\nexports.recoverMessageSigner = recoverMessageSigner;\nfunction verifyEIP712TypedDataSigner(typedData, signedData, expectedAddress) {\n    var dataBuff = (0, sign_typed_data_utils_1.generateTypedDataHash)(typedData);\n    var trimmedData = dataBuff.toString('hex');\n    return verifySignatureWithoutPrefix((0, address_1.ensureLeading0x)(trimmedData), signedData, expectedAddress);\n}\nexports.verifyEIP712TypedDataSigner = verifyEIP712TypedDataSigner;\nfunction verifySignatureWithoutPrefix(messageHash, signature, signer) {\n    try {\n        (0, signatureUtils_1.parseSignatureWithoutPrefix)(messageHash, signature, signer);\n        return true;\n    }\n    catch (error) {\n        return false;\n    }\n}\nexports.verifySignatureWithoutPrefix = verifySignatureWithoutPrefix;\nfunction decodeSig(sig) {\n    var _a = eth_lib_1.account.decodeSignature(sig), v = _a[0], r = _a[1], s = _a[2];\n    return {\n        v: parseInt(v, 16),\n        r: ethUtil.toBuffer(r),\n        s: ethUtil.toBuffer(s),\n    };\n}\nexports.decodeSig = decodeSig;\n//# sourceMappingURL=signing-utils.js.map"]},"metadata":{},"sourceType":"script"}